<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>INF402 - Futoshiki</title>
    <link rel="stylesheet" href="style.css"/>

    <script type="application/javascript" src="lib/jquery-3.4.1.js"></script>
    <script type="application/javascript" src="lib/minisat.js"></script>
    <script type="application/javascript" src="futoshiki.js"></script>
    <script type="application/javascript">
        const CELL_VALUES = ['0','1','2','3','4'];
        const OPERATOR_VALUES = ['0','&lt;','&gt;'];


        jQuery(function() {
            function initialize() {
                reset();

                const $cells=jQuery('#grid-template > div');
                $cells.appendTo('#puzzle');
                $cells.clone().appendTo('#solution');

                const $all_cells = jQuery('#puzzle div.cell');
                $all_cells.click(function(event) {
                    const $target = jQuery(event.target);
                    const index = CELL_VALUES.indexOf($target.html());
                    $target.html(CELL_VALUES[(index+1)%5]);
                    update_rpl();
                });

                const $all_operators = jQuery('#puzzle div.operator');
                $all_operators.click(function(event) {
                    const $target = jQuery(event.target);
                    const index = OPERATOR_VALUES.indexOf($target.html());
                    $target.html(OPERATOR_VALUES[(index+1)%3]);
                    update_rpl();
                });

            }

            function reset() {
                const $all_cells = jQuery('div.cell');
                const $all_operators = jQuery('div.operator');
                $all_cells.html(CELL_VALUES[0]);
                $all_operators.html('<span>'+OPERATOR_VALUES[0]+'</span>');
                update_rpl();

                const $solution_grid = jQuery('#solution_grid');
                $solution_grid.remove();
            }

            function update_rpl() {
                let rpl = '';
                const $all_cells = jQuery('#puzzle div.cell');
                jQuery.each($all_cells,function(index,div) {
                    const $div = jQuery(div);
                    const value = $div.text();
                    if (value != '0') {
                        const square = div.id;
                        rpl = rpl + square + value + '\n';
                    }
                });

                const $all_operators = jQuery('#puzzle div.operator');
                jQuery.each($all_operators,function(index,div) {
                    const $div = jQuery(div);
                    const value = $div.text();
                    if (value != '0') {
                        const squares = div.id.split('');

                        rpl = rpl + squares.join(value) + '\n';
                    }
                });

                const $rpl = jQuery('#rpl');
                $rpl.html(rpl);
            }

            function update_solution(solution) {
                const $solution = jQuery('#solution');
                $solution.find('.cell').map(function(i,cell) {
                    jQuery(cell).text(solution[i]);
                });
            }

            initialize();

            jQuery('#button_to_run').click(function() {
                const $textarea = jQuery('#rpl');
                const rpl = $textarea.val().split('\n');
                const dimacs = rpl2dimacs(rpl);
                const solution_as_dimacs = solve(dimacs);
                const solution_as_array = dimacs2pretty(solution_as_dimacs);
                update_solution(solution_as_array.flat());
            });

            jQuery('#button_to_reset').click(reset);
        });
    </script>
</head>
<body>
<h2>Futoshiki</h2>

<div id="puzzle" class="grid"></div>

<hr>
<textarea id="rpl" rows="5"></textarea>
<button id="button_to_run">RUN</button>
<button id="button_to_reset">RESET</button>
<hr>

<div id="solution" class="grid"></div>

<div id="grid-template" style="display:none">
    <div id="A" class="cell">0</div>
    <div id="AB" class="horizontal operator">0</div>
    <div id="B" class="cell">0</div>
    <div id="BC" class="horizontal operator">0</div>
    <div id="C" class="cell">0</div>
    <div id="CD" class="horizontal operator">0</div>
    <div id="D" class="cell">0</div>
    <div id="AE" class="vertical operator"><span>0</span></div>
    <div class="spacer"></div>
    <div id="BF" class="vertical operator"><span>0</span></div>
    <div class="spacer"></div>
    <div id="CG" class="vertical operator"><span>0</span></div>
    <div class="spacer"></div>
    <div id="DH" class="vertical operator"><span>0</span></div>
    <div id="E" class="cell">0</div>
    <div id="EF" class="horizontal operator">0</div>
    <div id="F" class="cell">0</div>
    <div id="FG" class="horizontal operator">0</div>
    <div id="G" class="cell">0</div>
    <div id="GH" class="horizontal operator">0</div>
    <div id="H" class="cell">0</div>
    <div id="EI" class="vertical operator"><span>0</span></div>
    <div class="spacer"></div>
    <div id="FJ" class="vertical operator"><span>0</span></div>
    <div class="spacer"></div>
    <div id="GK" class="vertical operator"><span>0</span></div>
    <div class="spacer"></div>
    <div id="HL" class="vertical operator"><span>0</span></div>
    <div id="I" class="cell">0</div>
    <div id="IJ" class="horizontal operator">0</div>
    <div id="J" class="cell">0</div>
    <div id="JK" class="horizontal operator">0</div>
    <div id="K" class="cell">0</div>
    <div id="KL" class="horizontal operator">0</div>
    <div id="L" class="cell">0</div>
    <div id="IM" class="vertical operator"><span>0</span></div>
    <div class="spacer"></div>
    <div id="JN" class="vertical operator"><span>0</span></div>
    <div class="spacer"></div>
    <div id="KO" class="vertical operator"><span>0</span></div>
    <div class="spacer"></div>
    <div id="LP" class="vertical operator"><span>0</span></div>
    <div id="M" class="cell">0</div>
    <div id="MN" class="horizontal operator">0</div>
    <div id="N" class="cell">0</div>
    <div id="NO" class="horizontal operator">0</div>
    <div id="O" class="cell">0</div>
    <div id="OP" class="horizontal operator">0</div>
    <div id="P" class="cell">0</div>
</div>

</body>
</html>