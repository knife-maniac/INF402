<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>INF402 - Futoshiki (tests)</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script type="application/javascript" src="lib/jquery-3.4.1.min.js"></script>
    <script type="application/javascript" src="lib/minisat.js"></script>
    <script type="application/javascript" src="futoshiki.js"></script>

    <style>
        body {
            font-family: sans-serif;
        }
        table {
            border-collapse: collapse;
            margin: auto;
            width: 80%;
        }
        tr.test:nth-child(even) {
            background-color: #eeeeee;
        }
        td {
            padding: 10px;
            vertical-align: top;
        }
        td.code {
            white-space:pre;
            font-family: monospace;
        }
        span.done {
            color:green;
        }
        span.error {
            color:red;
        }
    </style>

    <script type="application/javascript">

        jQuery(function() {
            const $=jQuery;

            function number_of_occurrences_in_array(arr, x) {
                return arr.filter(e=>e===x).length;
            }

            function solution_is_valid(solution) {
                let is_valid = true;

                for (const row of solution) {
                    is_valid &= number_of_occurrences_in_array(row, '1') === 1;
                    is_valid &= number_of_occurrences_in_array(row, '2') === 1;
                    is_valid &= number_of_occurrences_in_array(row, '3') === 1;
                    is_valid &= number_of_occurrences_in_array(row, '4') === 1;
                }

                for (let i = 0; i < 4; i++) {
                    const column = [solution[0][i], solution[1][i], solution[2][i], solution[3][i]];
                    is_valid &= number_of_occurrences_in_array(column, '1') === 1;
                    is_valid &= number_of_occurrences_in_array(column, '2') === 1;
                    is_valid &= number_of_occurrences_in_array(column, '3') === 1;
                    is_valid &= number_of_occurrences_in_array(column, '4') === 1;
                }

                return is_valid;
            }


            function solution_respects_constraints (solution,rpl) {
                let result = true;
                for (const constraint of rpl.split().filter(e=>e.length>0)) {
                    const square_name = constraint[0];
                    const square_value = solution.flat()[SQUARES.indexOf(square_name)];
                    const operator_or_value = constraint[1];
                    if (['<','>'].includes(operator_or_value)) {
                        const operator = operator_or_value;
                        const other_square_name = constraint[2];
                        const other_square_value = solution.flat()[SQUARES.indexOf(other_square_name)];
                        result &= (operator==='<')? square_value<other_square_name : other_square_value<square_value;
                    } else {
                        const value = operator_or_value;
                        result &= value === square_value;
                    }
                    if (!result) {
                        break;
                    }

                }
                return result;
            }

            function integration_test(title, rpl, has_solution) {
                let success = false;
                let puzzle;
                try {
                    puzzle = run(rpl);
                    if (puzzle.solution_as_array.length) {
                        if (solution_is_valid(puzzle.solution_as_array) && solution_respects_constraints(puzzle.solution_as_array,rpl)) {
                            success = true;
                        }
                    } else {
                        success = !has_solution;
                    }
                } catch (e) {

                }
                return {puzzle,success};
            }


            const integration_tests = [
                ['one value', 'A1\n',true],
                ['three values', 'A1\nB2\nD4\n',true],
                ['three values + one inferior sign', 'A1\nB2\nD4\nK<O\n',true],

                ['two impossible values same square', 'A1\nA2\n',false],
                ['two impossible values same line adjacent', 'A1\nB1\n',false],
                ['two impossible values same line extremes', 'A2\nD2\n',false],
                ['two impossible values same column', 'A4\nM4\n',false]
            ];

            const $table = $('table.integration_tests');
            integration_tests.map(test_case=>{
                const [title, rpl, has_solution] = test_case;
                const result = integration_test(...test_case);
                const outcome = result.success ? 'done': 'error';
                $table.append(`
<tr class="test">
    <td><span class="material-icons ${outcome}">${outcome}</span></td>
    <td>${title}</td>
    <td class="code">${rpl.replace(/</g,'&lt;')}</td>
    <td class="code">${result.success ? result.puzzle.solution_as_array.map(r=>r.join(' ')).join('\n'):''}</td>
</tr>`);
            });

        });

    </script>
</head>
<body>
<table class="unit_tests">
    <tr>
        <th colspan="4" style=" text-align: left; border-bottom: 2px solid blue; color: blue">
            Tests unitaires
        </th>
    </tr><tr><td style="font-size: xx-small; padding: 0">&nbsp;</td></tr>
</table>

<table class="integration_tests" style="margin-top: 30px">
    <tr>
        <th colspan="4" style=" text-align: left; border-bottom: 2px solid blue; color: blue">
            Tests d'int√©gration
        </th>
    </tr><tr><td style="font-size: xx-small; padding: 0">&nbsp;</td></tr>
</table>
</body>